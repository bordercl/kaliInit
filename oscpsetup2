#!/usr/bin/env zsh
#
# oscpsetup2
# Implemented for markdown-code-runner usage
# Only executes ```bash run``` or ```zsh run``` blocks
# Skips unsupported run languages and unresolved <IP>
#

set -e

NOTE_FILE="$1"

if [[ -z "$NOTE_FILE" ]]; then
  echo "Usage: oscpsetup2 <note.md>"
  exit 1
fi

if [[ ! -f "$NOTE_FILE" ]]; then
  echo "[!] File not found: $NOTE_FILE"
  exit 1
fi

echo "[*] Processing run blocks in $NOTE_FILE"
echo

in_run_block=0
run_lang=""
buffer=""

while IFS= read -r line; do
  if [[ "$line" =~ ^\`\`\`(bash|zsh)[[:space:]]+run ]]; then
    run_lang="${match[1]}"
    in_run_block=1
    buffer=""
    continue
  fi

  if [[ "$line" == "```" && $in_run_block -eq 1 ]]; then
    if echo "$buffer" | grep -q "<IP>"; then
      echo "[SKIP] unresolved <IP> placeholder"
    else
      echo "[RUN] $run_lang"
      echo "------------------------"
      if [[ "$run_lang" == "bash" ]]; then
        bash -c "$buffer"
      elif [[ "$run_lang" == "zsh" ]]; then
        zsh -c "$buffer"
      fi
      echo "------------------------"
    fi
    in_run_block=0
    run_lang=""
    buffer=""
    continue
  fi

  if [[ $in_run_block -eq 1 ]]; then
    buffer+="$line"$'\n'
  fi

done < "$NOTE_FILE"