#!/usr/bin/env python3

"""
OSCP note.md generator (Phase 1)
Implemented in Python using Jinja2 templating

- Reads template.md
- DOES NOT remove Example section (manual deletion if needed)
- Extracts TARGET block (<!-- TARGET START --> ... <!-- TARGET END -->)
- Prompts user for target IPs
- Replaces <IP> and <N> placeholders
- Duplicates TARGET block per IP
- Saves IPs to targets.txt
- Generates note.md
- Handles existing files with overwrite confirmation (y/N/(A)ll)
"""

from jinja2 import Template
import os
import sys

TEMPLATE_FILE = "template.md"
TARGET_FILE = "targets.txt"
OUTPUT_FILE = "note.md"

overwrite_all = False


def confirm_overwrite(path):
    global overwrite_all

    if not os.path.exists(path):
        return

    if overwrite_all:
        return

    ans = input(f"[!] {path} already exists. Overwrite? (y/N/(A)ll): ").strip().lower()

    if ans in ("a", "all"):
        overwrite_all = True
        return
    elif ans == "y":
        return
    else:
        print("[*] Aborted")
        sys.exit(0)


def get_targets():
    print("[*] Enter target IPs (one per line). Empty line to finish:")
    targets = []
    while True:
        line = input("> ").strip()
        if not line:
            break
        targets.append(line)
    return targets


def extract_target_block(text):
    start = "<!-- TARGET START -->"
    end = "<!-- TARGET END -->"

    if start not in text or end not in text:
        print("[!] TARGET block not found in template.md")
        sys.exit(1)

    before, rest = text.split(start, 1)
    block, after = rest.split(end, 1)

    return before, block, after


def main():
    print(
r"""
                                         __                
  ____  ______ ____ ______  ______ _____/  |_ __ ________  
 /  _ \/  ___// ___\\____ \/  ___// __ \   __\  |  \____ \ 
(  <_> )___ \\  \___|  |_> >___ \\  ___/|  | |  |  /  |_> >
 \____/____  >\___  >   __/____  >\___  >__| |____/|   __/ 
           \/     \/|__|       \/     \/           |__|    
"""
    )

    confirm_overwrite(TARGET_FILE)
    confirm_overwrite(OUTPUT_FILE)

    try:
        with open(TEMPLATE_FILE, "r") as f:
            template_text = f.read()
    except FileNotFoundError:
        print(f"[!] {TEMPLATE_FILE} not found")
        sys.exit(1)

    before, target_block, after = extract_target_block(template_text)

    targets = get_targets()
    if not targets:
        print("[!] No targets provided")
        sys.exit(1)

    with open(TARGET_FILE, "w") as f:
        for ip in targets:
            f.write(ip + "\n")

    rendered_blocks = []
    for idx, ip in enumerate(targets, start=1):
        block = target_block.replace("<IP>", ip).replace("<N>", str(idx))
        rendered_blocks.append(block)

    final_note = before + "".join(rendered_blocks) + after

    with open(OUTPUT_FILE, "w") as f:
        f.write(final_note)

    print(f"[+] targets.txt written ({len(targets)} targets)")
    print("[+] note.md generated")


if __name__ == "__main__":
    main()