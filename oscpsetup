#!/usr/bin/env python3

"""
OSCP note.md generator (Phase 1)

- Reads template.md
- Prompts user for target IPs
- Saves IPs to targets.txt
- Generates note.md with IP-specific blocks
- Handles existing files with overwrite confirmation (y/N/(A)ll)
"""

from jinja2 import Template
import os
import sys

TEMPLATE_FILE = "template.md"
TARGET_FILE = "targets.txt"
OUTPUT_FILE = "note.md"

overwrite_all = False


def confirm_overwrite(path):
    """Check if file exists and prompt for overwrite"""
    global overwrite_all

    if not os.path.exists(path):
        return

    if overwrite_all:
        return

    ans = input(f"[!] {path} already exists. Overwrite? (y/N/(A)ll): ").strip().lower()

    if ans in ("a", "all"):
        overwrite_all = True
        return
    elif ans == "y":
        return
    else:
        print("[*] Aborted")
        sys.exit(0)


def get_targets():
    """Prompt user to enter multiple IPs"""
    print("[*] Enter target IPs (one per line). Empty line to finish:")
    targets = []
    while True:
        line = input("> ").strip()
        if not line:
            break
        targets.append(line)
    return targets


def main():
    # check existing files
    confirm_overwrite(TARGET_FILE)
    confirm_overwrite(OUTPUT_FILE)

    # load template
    try:
        with open(TEMPLATE_FILE, "r") as f:
            template = Template(f.read())
    except FileNotFoundError:
        print(f"[!] {TEMPLATE_FILE} not found")
        sys.exit(1)

    # get target IPs
    targets = get_targets()
    if not targets:
        print("[!] No targets provided")
        sys.exit(1)

    # save targets.txt
    with open(TARGET_FILE, "w") as f:
        for ip in targets:
            f.write(ip + "\n")

    # render note.md
    rendered = template.render(targets=targets)
    with open(OUTPUT_FILE, "w") as f:
        f.write(rendered)

    print(f"[+] targets.txt written ({len(targets)} targets)")
    print("[+] note.md generated")


if __name__ == "__main__":
    main()